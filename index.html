<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç½‘ç›˜æé€Ÿä»£ä¸‹ V6.0</title>
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: system-ui; background: #f1f5f9; display: flex; justify-content: center; padding-top: 50px; }
        .container { background: white; padding: 30px; border-radius: 20px; width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        h3 { text-align: center; margin-top: 0; }
        input, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid #e2e8f0; box-sizing: border-box; }
        button { background: #6366f1; color: white; font-weight: bold; cursor: pointer; border: none; }
        #progress-bar { height: 12px; background: #eee; border-radius: 6px; overflow: hidden; margin: 15px 0; }
        #progress-fill { height: 100%; background: #10b981; width: 0%; transition: width 0.1s; }
        #stats { font-size: 13px; color: #64748b; text-align: center; }
        /* é’ˆå¯¹ GitHub å®‰å…¨é™åˆ¶çš„ç¡®è®¤æ¡† */
        #confirm-box { background: #fffbeb; border: 2px dashed #f59e0b; padding: 15px; border-radius: 12px; display: none; margin-bottom: 15px; }
    </style>
</head>
<body>
<div class="container">
    <h3>ç½‘ç›˜æé€Ÿä»£ä¸‹</h3>
    <div id="status-bar" style="font-size:12px; margin-bottom:10px; color:#94a3b8;">çŠ¶æ€: æ­£åœ¨åˆå§‹åŒ–...</div>
    
    <div id="input-area">
        <input type="text" id="u" placeholder="è´¦å·">
        <input type="password" id="p" placeholder="å¯†ç ">
        <input type="text" id="share-url" placeholder="ç²˜è´´ç½‘ç›˜é“¾æ¥">
        <button onclick="doLoginAndSubmit()">æäº¤ä»£ä¸‹ç”³è¯·</button>
    </div>

    <div id="confirm-box">
        <p style="font-size:13px; color:#854d0e; margin:0 0 10px 0; font-weight:bold;">ğŸ ç®¡ç†å‘˜å·²å‘è´§ï¼</p>
        <p id="file-info" style="font-size:12px; margin-bottom:10px;"></p>
        <button id="save-btn" style="background:#f59e0b;">ğŸ“ é€‰å¥½è·¯å¾„ï¼Œå¼€å§‹ä¸‹è½½</button>
    </div>

    <div id="transfer-zone" style="display:none;">
        <div id="progress-bar"><div id="progress-fill"></div></div>
        <div id="stats">ç­‰å¾…æ•°æ®ä¼ è¾“...</div>
    </div>
</div>

<script>
    const ADMIN_ID = 'MY_PRIVATE_STATION_2024'; // å¿…é¡»ä¸ç®¡ç†ç«¯ä¸€è‡´
    let peer, conn, recvCtx = null;

    peer = new Peer();
    peer.on('open', id => {
        document.getElementById('status-bar').innerText = 'æˆ‘çš„ ID: ' + id + ' (å°±ç»ª)';
    });

    function doLoginAndSubmit() {
        const u = document.getElementById('u').value;
        const p = document.getElementById('p').value;
        const task = document.getElementById('share-url').value;
        
        if(!u || !p || !task) return alert('è¯·å¡«å…¨è´¦å·ã€å¯†ç å’Œé“¾æ¥');

        conn = peer.connect(ADMIN_ID);
        conn.on('open', () => {
            conn.send({ type: 'AUTH', user: u, pass: p });
            conn.send({ type: 'TASK', rawText: task });
            document.getElementById('input-area').style.display = 'none';
            document.getElementById('transfer-zone').style.display = 'block';
            document.getElementById('stats').innerText = "ä»»åŠ¡å·²æäº¤ï¼Œç­‰å¾…ç®¡ç†ç«¯å‘å›æ–‡ä»¶...";
        });

        conn.on('data', onData);
    }

    async function onData(data) {
        if(data.type === 'meta') {
            // æ”¶åˆ°å…ƒæ•°æ®ï¼Œæ˜¾ç¤ºæ‰‹åŠ¿ç¡®è®¤æ¡†
            document.getElementById('file-info').innerText = `æ–‡ä»¶: ${data.name} (${(data.size/1024/1024).toFixed(2)}MB)`;
            document.getElementById('confirm-box').style.display = 'block';
            
            document.getElementById('save-btn').onclick = async () => {
                document.getElementById('confirm-box').style.display = 'none';
                await startWriter(data);
            };
        } else if(data.type === 'chunk') {
            handleChunk(data);
        }
    }

    async function startWriter(meta) {
        recvCtx = { ...meta, received: 0 };
        try {
            // HTTPS ç¯å¢ƒä¸‹å¯ç”¨ç£ç›˜ç›´å†™
            const handle = await window.showSaveFilePicker({ suggestedName: meta.name });
            recvCtx.writer = await handle.createWritable();
            conn.send({ type: 'READY_TO_RECEIVE' });
        } catch (e) {
            // é™çº§å†…å­˜æ¨¡å¼
            recvCtx.chunksArray = [];
            document.getElementById('stats').innerText = "âš ï¸ æ¨¡å¼: å†…å­˜æ¨¡å¼ (è¯·å‹¿å…³é—­é¡µé¢)";
            conn.send({ type: 'READY_TO_RECEIVE' });
        }
    }

    async function handleChunk(pkg) {
        if (recvCtx.writer) {
            await recvCtx.writer.write({ type: 'write', data: pkg.data, position: pkg.offset });
        } else {
            recvCtx.chunksArray[pkg.index] = pkg.data;
        }
        
        recvCtx.received++;
        // å¯¹é½å‚è€ƒä»£ç çš„è¿›åº¦æ¡æ›´æ–°
        if (recvCtx.received % 10 === 0 || pkg.isLast) {
            const percent = (recvCtx.received / recvCtx.chunks * 100).toFixed(1);
            document.getElementById('progress-fill').style.width = percent + '%';
            document.getElementById('stats').innerText = `æ­£åœ¨ä¼ è¾“: ${percent}%`;
        }

        if (pkg.isLast) {
            if (recvCtx.writer) await recvCtx.writer.close();
            else {
                const a = document.createElement('a');
                a.href = URL.createObjectURL(new Blob(recvCtx.chunksArray));
                a.download = recvCtx.name; a.click();
            }
            document.getElementById('stats').innerText = "ğŸ‰ ä¼ è¾“å®Œæˆï¼";
        }
    }
</script>
</body>
</html>
