<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P ä¼ è¾“ V5.0 - ä¸“å®¶è°ƒè¯•ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { 
            --p: #6366f1; --success: #10b981; --error: #ef4444; --warning: #f59e0b; 
            --bg: #f8fafc; --card-bg: rgba(255, 255, 255, 0.95);
        }
        body { font-family: system-ui, -apple-system, sans-serif; background: #f1f5f9; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 600px; background: var(--card-bg); border-radius: 20px; padding: 25px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        
        /* çŠ¶æ€æ˜¾ç¤ºåŒº */
        .status-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .status-card { background: #fff; padding: 10px; border-radius: 12px; border: 1px solid #e2e8f0; }
        .status-card label { display: block; font-size: 11px; color: #64748b; text-transform: uppercase; }
        .status-card strong { font-size: 13px; color: var(--p); word-break: break-all; }

        /* æ“ä½œåŒº */
        input, button { width: 100%; padding: 12px; margin: 5px 0; border-radius: 10px; border: 1px solid #e2e8f0; box-sizing: border-box; }
        button { background: var(--p); color: white; border: none; font-weight: 600; cursor: pointer; }
        button:disabled { background: #cbd5e1; }
        
        /* è¿›åº¦æ¡ */
        #progress-bar { width: 100%; height: 12px; background: #e2e8f0; border-radius: 6px; margin: 15px 0; display: none; overflow: hidden; }
        #progress-fill { width: 0%; height: 100%; background: var(--p); transition: width 0.2s; }
        #stats { text-align: center; font-size: 12px; color: #475569; margin-bottom: 10px; }

        /* å¢å¼ºå‹è°ƒè¯•çª—å£ */
        .debug-container { margin-top: 20px; }
        .debug-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .debug-header span { font-size: 12px; font-weight: bold; color: #1e293b; }
        .debug-log { 
            background: #0f172a; color: #cbd5e1; padding: 15px; border-radius: 12px; 
            font-size: 11px; height: 250px; overflow-y: auto; font-family: 'Consolas', monospace;
            line-height: 1.6; border: 1px solid #334155;
        }
        .log-line { margin-bottom: 4px; border-bottom: 1px solid #1e293b; padding-bottom: 2px; }
        .log-time { color: #64748b; margin-right: 8px; }
        .type-net { color: #38bdf8; }    /* ç½‘ç»œå±‚ */
        .type-io { color: #fbbf24; }     /* å­˜å‚¨å±‚ */
        .type-sync { color: #c084fc; }   /* ä¼ è¾“åŒæ­¥ */
        .type-err { color: #f87171; }    /* é”™è¯¯ */
        .type-ok { color: #4ade80; }     /* æˆåŠŸ */
    </style>
</head>
<body>

<div class="container">
    <h3 style="margin-top:0;">P2P ä¼ è¾“ä¸“å®¶ç‰ˆ <small style="font-weight: normal; color: #64748b;">V5.0</small></h3>
    
    <div class="status-grid">
        <div class="status-card"><label>æˆ‘çš„èŠ‚ç‚¹ ID</label><strong id="my-id">ç­‰å¾…åˆ†é…...</strong></div>
        <div class="status-card"><label>å­˜å‚¨å¥æŸ„çŠ¶æ€</label><strong id="storage-status">æœªåˆå§‹åŒ–</strong></div>
    </div>

    <div id="setup-area">
        <input type="text" id="remote-id" placeholder="è¾“å…¥è¿œç¨‹ Peer ID">
        <button onclick="handleConnect()">å»ºç«‹ P2P æ¡æ‰‹</button>
    </div>

    <div id="transfer-area" style="display:none;">
        <input type="file" id="file-input" onchange="onFilePicked()">
        <button id="send-btn" onclick="requestSend()" disabled>æ‰§è¡Œä¼ è¾“ä»»åŠ¡</button>
        
        <div id="receive-box" style="display:none; background: #f0fdf4; padding: 15px; border-radius: 12px; border: 1px solid #bbf7d0; margin: 10px 0;">
            <div id="incoming-info" style="font-size: 13px; color: #166534;"></div>
            <button onclick="acceptIncoming()" style="background: var(--success); margin-top:10px;">æ¥å—ä¼ è¾“</button>
        </div>

        <div id="progress-bar"><div id="progress-fill"></div></div>
        <div id="stats">é“¾è·¯å°±ç»ªï¼Œç­‰å¾…æŒ‡ä»¤</div>
    </div>

    <div class="debug-container">
        <div class="debug-header">
            <span>å®æ—¶ä¸“å®¶è°ƒè¯•æ—¥å¿—</span>
            <button onclick="document.getElementById('log-box').innerHTML=''" style="width:auto; padding:2px 8px; font-size:10px; background:#475569;">æ¸…ç©º</button>
        </div>
        <div class="debug-log" id="log-box"></div>
    </div>
</div>

<script>
    let peer, conn, curFile, recvCtx;
    let isSending = false, isReceiving = false;
    let lastAckedIndex = 0;
    let speedStats = { lastTime: 0, lastIndex: 0 };

    // æ ¼å¼åŒ–æ—¥å¿—å‡½æ•°
    function dlog(msg, category = 'info') {
        const box = document.getElementById('log-box');
        const categories = {
            net: 'type-net', // ç½‘ç»œ
            io: 'type-io',   // å­˜å‚¨
            sync: 'type-sync', // åŒæ­¥
            err: 'type-err', // é”™è¯¯
            ok: 'type-ok'    // æˆåŠŸ
        };
        const cls = categories[category] || '';
        const time = new Date().toLocaleTimeString('zh-CN', { hour12: false });
        box.innerHTML += `<div class="log-line"><span class="log-time">${time}</span><span class="${cls}">[${category.toUpperCase()}]</span> ${msg}</div>`;
        box.scrollTop = box.scrollHeight;
    }

    window.onbeforeunload = (e) => { if (isSending || isReceiving) return "ä¼ è¾“ä¸­"; };

    window.onload = () => {
        dlog("æ­£åœ¨åˆå§‹åŒ– PeerJS å¼•æ“...", "net");
        peer = new Peer({ config: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] } });
        peer.on('open', id => { 
            document.getElementById('my-id').textContent = id;
            dlog(`ä¿¡ä»¤è¿æ¥æˆåŠŸã€‚åˆ†é… ID: ${id}`, "net");
        });
        peer.on('connection', c => {
            dlog(`æ”¶åˆ°æ¥è‡ª ${c.peer} çš„è¿æ¥è¯·æ±‚`, "net");
            initConn(c);
        });
        peer.on('error', e => dlog(`Peer å¼•æ“æŠ¥é”™: ${e.type}`, "err"));
    };

    function initConn(c) {
        conn = c;
        conn.on('open', () => {
            document.getElementById('setup-area').style.display = 'none';
            document.getElementById('transfer-area').style.display = 'block';
            dlog(`P2P æ•°æ®é€šé“å·²æ‰“å¼€ã€‚å¯é ä¼ è¾“æ¨¡å¼: ${conn.reliable}`, "net");
        });
        conn.on('data', onData);
        conn.on('close', () => dlog("é€šé“å·²æ„å¤–å…³é—­", "err"));
    }

    function handleConnect() {
        const rid = document.getElementById('remote-id').value.trim();
        if (rid) {
            dlog(`å°è¯•å‘¼å«ç›®æ ‡: ${rid}`, "net");
            initConn(peer.connect(rid, { reliable: true }));
        }
    }

    function onFilePicked() {
        curFile = document.getElementById('file-input').files[0];
        if(curFile) {
            dlog(`æœ¬åœ°åŠ è½½æ–‡ä»¶: ${curFile.name} (${curFile.size} bytes)`, "io");
            document.getElementById('send-btn').disabled = false;
        }
    }

    function requestSend() {
        const totalChunks = Math.ceil(curFile.size / 262144);
        dlog(`å‘é€é¢„æ£€è¯·æ±‚ã€‚åˆ†ç‰‡æ€»æ•°: ${totalChunks}`, "sync");
        conn.send({
            type: 'meta', name: curFile.name, size: curFile.size,
            chunks: totalChunks, resumeIndex: lastAckedIndex
        });
    }

    async function executeSend(startIndex) {
        isSending = true;
        const total = Math.ceil(curFile.size / 262144);
        document.getElementById('progress-bar').style.display = 'block';
        speedStats = { lastTime: Date.now(), lastIndex: startIndex };

        dlog(`å¼€å§‹åˆ†ç‰‡å¾ªç¯ã€‚èµ·å§‹ç´¢å¼•: ${startIndex}`, "sync");

        for (let i = startIndex; i < total; i++) {
            if (!isSending) break;
            
            // è¯¦ç»†ç¼“å†²åŒºè°ƒè¯•
            if (conn.bufferSize > 1024 * 1024) { 
                dlog(`ç¼“å†²åŒºç§¯å‹: ${conn.bufferSize} bytes, æš‚åœç­‰å¾…å‘é€...`, "net");
                await new Promise(r => setTimeout(r, 200));
                i--; continue;
            }

            const start = i * 262144;
            const end = Math.min(curFile.size, start + 262144);
            const chunk = await curFile.slice(start, end).arrayBuffer();
            
            if (i % 50 === 0) dlog(`æ­£åœ¨å‘é€åˆ†ç‰‡ #${i} (Offset: ${start})`, "sync");

            conn.send({ type: 'chunk', data: chunk, index: i, offset: start, isLast: i === total - 1 });
        }
    }

    function onData(data) {
        if (data.type === 'meta') {
            recvCtx = { ...data, received: data.resumeIndex || 0 };
            dlog(`æ¥æ”¶ç«¯é¢„æ£€ã€‚æ–‡ä»¶: ${data.name}, æ–­ç‚¹: ${recvCtx.received}`, "io");
            document.getElementById('incoming-info').innerText = `è¯·æ±‚æ–‡ä»¶: ${data.name}`;
            document.getElementById('receive-box').style.display = 'block';
        } 
        else if (data.type === 'start-at') {
            dlog(`æ”¶åˆ°å¯¹ç«¯åé¦ˆã€‚å¼€å§‹ä½ç½®: ${data.index}`, "sync");
            executeSend(data.index);
        }
        else if (data.type === 'report-progress') {
            lastAckedIndex = data.index;
            updateUI(data.index, data.total, 'å‘é€é€Ÿåº¦');
            if (data.index >= data.total && isSending) {
                dlog("æ”¶åˆ°å¯¹ç«¯ 100% ç¡®è®¤å›ä¼ ï¼Œä»»åŠ¡æˆåŠŸ", "ok");
                completeSend();
            }
        }
        else if (data.type === 'chunk') {
            handleChunk(data);
        }
    }

    async function handleChunk(pkg) {
        if (!isReceiving) return;
        try {
            if (recvCtx.writer) {
                await recvCtx.writer.write({ type: 'write', data: pkg.data, position: pkg.offset });
            } else {
                recvCtx.chunksArray[pkg.index] = pkg.data;
            }
            recvCtx.received++;
            
            if (recvCtx.received % 50 === 0) {
                dlog(`å†™å…¥åˆ†ç‰‡ #${pkg.index}, å½“å‰å·²å­˜: ${recvCtx.received} å—`, "io");
            }

            if (recvCtx.received % 10 === 0 || pkg.isLast) {
                conn.send({ type: 'report-progress', index: recvCtx.received, total: recvCtx.chunks });
                updateUI(recvCtx.received, recvCtx.chunks, 'æ¥æ”¶é€Ÿåº¦');
            }
            if (pkg.isLast) completeTransfer();
        } catch (e) { dlog(`ç£ç›˜å†™å…¥å¼‚å¸¸: ${e.message}`, "err"); isReceiving = false; }
    }

    async function completeTransfer() {
        isReceiving = false;
        document.getElementById('progress-fill').style.width = '100%';
        document.getElementById('stats').innerHTML = '<span style="color:var(--success)">âœ… æ¥æ”¶å®Œæˆ</span>';
        if (recvCtx.writer) {
            dlog("æ­£åœ¨å…³é—­æ–‡ä»¶å¥æŸ„ï¼Œå¼ºåˆ¶åˆ·ç›˜...", "io");
            await recvCtx.writer.close();
        } else {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob(recvCtx.chunksArray));
            a.download = recvCtx.name; a.click();
        }
        dlog(`æ–‡ä»¶ ${recvCtx.name} ä¼ è¾“ç»“æŸï¼Œä»»åŠ¡åœ†æ»¡å®Œæˆ`, "ok");
    }

    function completeSend() {
        isSending = false;
        document.getElementById('progress-fill').style.width = '100%';
        document.getElementById('stats').innerHTML = '<span style="color:var(--success)">ğŸ‰ å‘é€æˆåŠŸ</span>';
        dlog("å‘é€å¾ªç¯å·²åœæ­¢ï¼Œå¯¹ç«¯ç¡®è®¤å­˜ç›˜", "ok");
    }

    async function acceptIncoming() {
        const s = document.getElementById('storage-status');
        try {
            if (!window.showSaveFilePicker) throw 'Unsupported';
            dlog("æ­£åœ¨è¯·æ±‚ç£ç›˜å†™å…¥æƒé™...", "io");
            const handle = await window.showSaveFilePicker({ suggestedName: recvCtx.name });
            recvCtx.writer = await handle.createWritable();
            s.innerText = "FileSystem API (æµå¼)";
            dlog("å­˜å‚¨æ¨¡å¼: ç£ç›˜ç›´æ¥å†™å…¥ (Secure Mode)", "io");
        } catch (e) {
            recvCtx.chunksArray = [];
            s.innerText = "Memory (å†…å­˜æ¨¡å¼)";
            dlog("å­˜å‚¨æ¨¡å¼: é™çº§ä¸º RAM ç¼“å†² (å¯èƒ½å¯¼è‡´ OOM)", "warning");
        }
        isReceiving = true;
        document.getElementById('receive-box').style.display = 'none';
        document.getElementById('progress-bar').style.display = 'block';
        conn.send({ type: 'start-at', index: recvCtx.received });
    }

    function updateUI(cur, total, label) {
        const p = Math.min(100, Math.round((cur / total) * 100));
        document.getElementById('progress-fill').style.width = p + '%';
        const now = Date.now(), diff = (now - speedStats.lastTime) / 1000;
        if (diff >= 1) {
            const speed = (((cur - speedStats.lastIndex) * 262144) / 1024 / 1024 / diff).toFixed(2);
            document.getElementById('stats').innerText = `${label}: ${speed} MB/s (${p}%)`;
            speedStats.lastTime = now; speedStats.lastIndex = cur;
        }
    }
</script>
</body>
</html>
