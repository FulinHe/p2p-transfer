<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æé€Ÿä»£ä¸‹ - æäº¤ç«¯ V5.8</title>
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --p: #6366f1; --s: #10b981; }
        body { font-family: system-ui; background: #f1f5f9; display: flex; justify-content: center; padding-top: 50px; margin: 0; }
        .card { background: white; padding: 30px; border-radius: 24px; width: 100%; max-width: 400px; box-shadow: 0 20px 40px rgba(0,0,0,0.05); }
        h3 { text-align: center; color: #1e293b; margin-bottom: 20px; }
        input, textarea, button { width: 100%; padding: 14px; margin: 10px 0; border-radius: 12px; border: 1px solid #e2e8f0; box-sizing: border-box; font-size: 15px; transition: 0.3s; }
        textarea { height: 120px; resize: none; border: 2px solid var(--p); outline: none; }
        button { background: var(--p); color: white; border: none; font-weight: bold; cursor: pointer; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        button:disabled { background: #cbd5e1; cursor: not-allowed; }
        #pb { height: 8px; background: #eee; border-radius: 4px; display: none; overflow: hidden; margin-top: 20px; }
        #fill { height: 100%; background: var(--s); width: 0%; transition: width 0.1s; }
        .st { font-size: 13px; text-align: center; margin-top: 15px; padding: 12px; border-radius: 10px; line-height: 1.6; }
        .bg-ok { background: #dcfce7; color: #15803d; border: 1px solid #bbf7d0; }
        .bg-err { background: #fee2e2; color: #ef4444; border: 1px solid #fecaca; }
        .bg-wait { background: #fef9c3; color: #854d0e; border: 1px solid #fef08a; }
    </style>
</head>
<body>

<div class="card">
    <h3 id="ui-title">ğŸš€ æé€Ÿæ¨é€é€šé“</h3>
    
    <div id="auth-box">
        <input type="text" id="u" placeholder="è¾“å…¥æ‚¨çš„è´¦å·">
        <input type="password" id="p" placeholder="è¾“å…¥ç™»å½•å¯†ç ">
        <button id="login-btn" onclick="doLogin()">éªŒè¯èº«ä»½</button>
        <p class="st">è¯·ç¡®ä¿ä½¿ç”¨ Chrome/Edge æµè§ˆå™¨ä»¥è·å¾— 1000Mbps è¾¹ä¸‹è¾¹å­˜ä½“éªŒ</p>
    </div>

    <div id="main-box" style="display:none;">
        <textarea id="raw" placeholder="ç²˜è´´å®Œæ•´çš„ç½‘ç›˜åˆ†äº«ä¿¡æ¯..."></textarea>
        <button onclick="doSubmit()">æäº¤ä¸‹è½½ä»»åŠ¡</button>
        <div id="pb"><div id="fill"></div></div>
        <div id="st-box" class="st bg-wait">ç­‰å¾…ä»»åŠ¡ä¸‹å‘...</div>
    </div>
</div>

<script>
    // æ³¨æ„ï¼šç¡®ä¿æ­¤ ID ä¸ç®¡ç†ç«¯ä¸€è‡´
    const ADMIN_ID = 'MY_PRIVATE_STATION_2024'; 
    let peer, conn, recvCtx = null;

    function doLogin() {
        const u = document.getElementById('u').value;
        const p = document.getElementById('p').value;
        if(!u || !p) return;

        document.getElementById('login-btn').disabled = true;
        document.getElementById('login-btn').innerText = "æ­£åœ¨å»ºç«‹ P2P è¿æ¥...";

        peer = new Peer();
        peer.on('open', () => {
            conn = peer.connect(ADMIN_ID);
            conn.on('open', () => {
                conn.send({ type: 'AUTH', user: u, pass: p });
            });
            conn.on('data', onData);
        });

        peer.on('error', () => {
            alert("æ— æ³•è¿æ¥åˆ°ç®¡ç†ç«¯ï¼Œè¯·ç¡®è®¤ç®¡ç†å‘˜å·²å¼€å¯æœåŠ¡ã€‚");
            location.reload();
        });
    }

    async function onData(data) {
        const st = document.getElementById('st-box');
        if(data.type === 'AUTH_OK') {
            document.getElementById('auth-box').style.display = 'none';
            document.getElementById('main-box').style.display = 'block';
        } else if(data.type === 'AUTH_ERR') {
            alert("è´¦å·æˆ–å¯†ç é”™è¯¯");
            location.reload();
        } else if(data.type === 'meta') {
            await prepareWriter(data);
        } else if(data.type === 'chunk') {
            receiveData(data);
        }
    }

    // æ ¸å¿ƒï¼šåŸºäº FileSystem Access API çš„ç›´å†™é€»è¾‘
    async function prepareWriter(meta) {
        recvCtx = { ...meta, received: 0 };
        const st = document.getElementById('st-box');
        document.getElementById('pb').style.display = 'block';

        try {
            // HTTPS ç¯å¢ƒä¸‹ window.showSaveFilePicker æ‰æœ‰æ•ˆ
            if (!window.showSaveFilePicker) throw new Error("æµè§ˆå™¨ç‰ˆæœ¬è¿‡ä½æˆ–é HTTPS ç¯å¢ƒ");
            
            st.innerText = "ğŸš¨ ç®¡ç†å‘˜å‡†å¤‡å‘è´§ï¼Œè¯·åœ¨å¼¹çª—ä¸­é€‰æ‹©ä¿å­˜è·¯å¾„";
            const handle = await window.showSaveFilePicker({ suggestedName: meta.name });
            recvCtx.writer = await handle.createWritable();
            
            st.className = "st bg-ok";
            st.innerText = "âœ… è¾¹ä¸‹è¾¹å­˜å·²æ¿€æ´»ï¼Œæ­£åœ¨å…¨é€Ÿæ‹‰å–æ•°æ®...";
            conn.send({ type: 'READY_TO_RECEIVE' }); 
        } catch (e) {
            recvCtx.chunksArray = []; // é™çº§å†…å­˜æ¨¡å¼
            st.className = "st bg-err";
            st.innerText = "âš ï¸ é™çº§ä¸ºå†…å­˜æ¨¡å¼ï¼š" + e.message;
            conn.send({ type: 'READY_TO_RECEIVE' });
        }
    }

    async function receiveData(pkg) {
        if (recvCtx.writer) {
            await recvCtx.writer.write({ type: 'write', data: pkg.data, position: pkg.offset });
        } else {
            recvCtx.chunksArray[pkg.index] = pkg.data;
        }
        recvCtx.received++;
        const p = (recvCtx.received / recvCtx.chunks) * 100;
        document.getElementById('fill').style.width = p + '%';
        
        if (pkg.isLast) {
            if (recvCtx.writer) await recvCtx.writer.close();
            else {
                const a = document.createElement('a');
                a.href = URL.createObjectURL(new Blob(recvCtx.chunksArray));
                a.download = recvCtx.name; a.click();
            }
            document.getElementById('st-box').innerText = "ğŸ‰ æ–‡ä»¶ä¼ è¾“æˆåŠŸå¹¶å·²å­˜å…¥ç¡¬ç›˜ï¼";
        }
    }

    function doSubmit() {
        conn.send({ type: 'TASK', rawText: document.getElementById('raw').value });
        document.getElementById('st-box').innerText = "ä»»åŠ¡å·²æäº¤ï¼Œè¯·ç­‰å¾…ç®¡ç†å‘˜æ¨é€...";
        document.getElementById('raw').value = "";
    }
</script>
</body>
</html>
