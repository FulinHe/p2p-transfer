<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æé€Ÿä»£ä¸‹ - æäº¤ç«¯ V5.9 (æ‰‹åŠ¿æ¿€æ´»ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --p: #6366f1; --s: #10b981; --warn: #f59e0b; }
        body { font-family: system-ui; background: #f1f5f9; display: flex; justify-content: center; padding-top: 50px; margin: 0; }
        .card { background: white; padding: 30px; border-radius: 24px; width: 100%; max-width: 420px; box-shadow: 0 20px 40px rgba(0,0,0,0.05); }
        h3 { text-align: center; color: #1e293b; margin-bottom: 20px; }
        input, textarea, button { width: 100%; padding: 14px; margin: 10px 0; border-radius: 12px; border: 1px solid #e2e8f0; box-sizing: border-box; font-size: 15px; }
        textarea { height: 100px; resize: none; border: 2px solid var(--p); outline: none; }
        button { background: var(--p); color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        
        /* æ ¸å¿ƒï¼šæ¥æ”¶ç¡®è®¤æ¡†æ ·å¼ */
        #recv-confirm-box { 
            background: #fffbeb; border: 2px dashed var(--warn); padding: 15px; 
            border-radius: 15px; margin: 15px 0; display: none; animation: slideDown 0.3s ease;
        }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        #pb { height: 10px; background: #eee; border-radius: 5px; display: none; overflow: hidden; margin-top: 20px; }
        #fill { height: 100%; background: var(--s); width: 0%; transition: width 0.1s; }
        .st { font-size: 13px; text-align: center; margin-top: 15px; padding: 12px; border-radius: 10px; line-height: 1.6; }
        .bg-ok { background: #dcfce7; color: #15803d; }
        .bg-err { background: #fee2e2; color: #ef4444; }
        .bg-wait { background: #f1f5f9; color: #64748b; }
    </style>
</head>
<body>

<div class="card">
    <h3>ğŸš€ æé€Ÿæ¨é€é€šé“ V5.9</h3>
    
    <div id="auth-box">
        <input type="text" id="u" placeholder="è¾“å…¥æ‚¨çš„è´¦å·">
        <input type="password" id="p" placeholder="è¾“å…¥ç™»å½•å¯†ç ">
        <button id="login-btn" onclick="doLogin()">è¿›å…¥åŠ é€Ÿé€šé“</button>
    </div>

    <div id="main-box" style="display:none;">
        <textarea id="raw" placeholder="ç²˜è´´ç½‘ç›˜åˆ†äº«ä¿¡æ¯..."></textarea>
        <button onclick="doSubmit()">æäº¤ä¸‹è½½ä»»åŠ¡</button>

        <div id="recv-confirm-box">
            <p style="font-size: 13px; color: #854d0e; margin: 0 0 10px 0; font-weight: bold;">ğŸ ç®¡ç†å‘˜å·²å‘è´§ï¼</p>
            <p id="file-info" style="font-size: 12px; margin-bottom: 12px; color: #b45309;"></p>
            <button id="real-save-btn" style="background: var(--warn);">ğŸ“ é€‰å¥½è·¯å¾„ï¼Œå¼€å§‹ä¸‹è½½</button>
        </div>

        <div id="pb"><div id="fill"></div></div>
        <div id="st-box" class="st bg-wait">å°±ç»ªï¼šç­‰å¾…ä»»åŠ¡ä¸‹å‘</div>
    </div>
</div>

<script>
    const ADMIN_ID = 'MY_PRIVATE_STATION_2024'; 
    let peer, conn, recvCtx = null, tempMeta = null;

    function doLogin() {
        const u = document.getElementById('u').value;
        const p = document.getElementById('p').value;
        if(!u || !p) return;
        document.getElementById('login-btn').disabled = true;
        document.getElementById('login-btn').innerText = "è¿æ¥ä¸­...";

        peer = new Peer();
        peer.on('open', () => {
            conn = peer.connect(ADMIN_ID);
            conn.on('open', () => {
                conn.send({ type: 'AUTH', user: u, pass: p });
            });
            conn.on('data', onData);
        });
    }

    async function onData(data) {
        if(data.type === 'AUTH_OK') {
            document.getElementById('auth-box').style.display = 'none';
            document.getElementById('main-box').style.display = 'block';
        } else if(data.type === 'meta') {
            // ç¬¬ä¸€æ­¥ï¼šå­˜å‚¨å…ƒæ•°æ®ï¼Œæ˜¾ç¤ºé»„è‰²ç¡®è®¤æ¡† 
            tempMeta = data;
            document.getElementById('file-info').innerText = `æ–‡ä»¶å: ${data.name}\nå¤§å°: ${(data.size/1024/1024).toFixed(2)} MB`;
            document.getElementById('recv-confirm-box').style.display = 'block';
            document.getElementById('st-box').innerText = "ç­‰å¾…ç”¨æˆ·æ‰‹åŠ¨å¼€å¯ç£ç›˜å†™å…¥æƒé™...";
            
            // ç¬¬äºŒæ­¥ï¼šç»‘å®šç”¨æˆ·ç‚¹å‡»äº‹ä»¶
            document.getElementById('real-save-btn').onclick = async () => {
                document.getElementById('recv-confirm-box').style.display = 'none';
                await activateFileSystem(tempMeta);
            };
        } else if(data.type === 'chunk') {
            receiveChunk(data);
        }
    }

    async function activateFileSystem(meta) {
        recvCtx = { ...meta, received: 0 };
        const st = document.getElementById('st-box');
        document.getElementById('pb').style.display = 'block';

        try {
            // å› ä¸ºåœ¨ onclick å›è°ƒå†…ï¼Œæµè§ˆå™¨å…è®¸å¼¹å‡ºä¿å­˜æ¡†
            const handle = await window.showSaveFilePicker({ suggestedName: meta.name });
            recvCtx.writer = await handle.createWritable();
            
            st.className = "st bg-ok";
            st.innerText = "âœ… è·¯å¾„å·²é”å®šï¼šç£ç›˜ç›´å†™ä¸­...";
            // åé¦ˆä¿¡å·ï¼šå‘ŠçŸ¥ç®¡ç†ç«¯å¼€å§‹åæ•°æ®
            conn.send({ type: 'READY_TO_RECEIVE' }); 
        } catch (e) {
            recvCtx.chunksArray = []; 
            st.className = "st bg-err";
            st.innerText = "âš ï¸ æ¨¡å¼: å†…å­˜ç¼“å­˜ (" + e.message + ")";
            conn.send({ type: 'READY_TO_RECEIVE' });
        }
    }

    async function receiveChunk(pkg) {
        if (recvCtx.writer) {
            await recvCtx.writer.write({ type: 'write', data: pkg.data, position: pkg.offset });
        } else {
            recvCtx.chunksArray[pkg.index] = pkg.data;
        }
        recvCtx.received++;
        const p = (recvCtx.received / recvCtx.chunks) * 100;
        document.getElementById('fill').style.width = p + '%';
        if (pkg.isLast) {
            if (recvCtx.writer) await recvCtx.writer.close();
            else {
                const a = document.createElement('a');
                a.href = URL.createObjectURL(new Blob(recvCtx.chunksArray));
                a.download = recvCtx.name; a.click();
            }
            document.getElementById('st-box').innerText = "ğŸ‰ ä¼ è¾“å®Œæˆï¼";
        }
    }

    function doSubmit() {
        conn.send({ type: 'TASK', rawText: document.getElementById('raw').value });
        document.getElementById('st-box').innerText = "ä»»åŠ¡å·²æäº¤...";
        document.getElementById('raw').value = "";
    }
</script>
</body>
</html>
