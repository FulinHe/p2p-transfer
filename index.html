<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æé€Ÿä»£ä¸‹ - V7.9</title>
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --p: #6366f1; --s: #10b981; --err: #ef4444; --gray: #94a3b8; }
        body { font-family: system-ui; background: #f1f5f9; display: flex; justify-content: center; padding-top: 50px; margin: 0; }
        .card { background: white; padding: 30px; border-radius: 24px; width: 380px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        
        /* çŠ¶æ€ç¯æ ·å¼ */
        .status-tag { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; background: #f8fafc; border: 1px solid #e2e8f0; margin-bottom: 20px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--gray); transition: 0.3s; }
        .dot.online { background: var(--s); box-shadow: 0 0 8px var(--s); }
        .dot.sync { background: var(--p); box-shadow: 0 0 8px var(--p); }
        .dot.error { background: var(--err); }
        
        h3 { text-align: center; color: #1e293b; margin: 0 0 10px 0; }
        input, textarea, button { width: 100%; padding: 14px; margin: 10px 0; border-radius: 12px; border: 1px solid #e2e8f0; box-sizing: border-box; font-size: 14px; }
        button { background: var(--p); color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button:disabled { background: #cbd5e1; cursor: not-allowed; }
        
        #progress-bar { height: 10px; background: #eee; border-radius: 5px; overflow: hidden; margin-top: 20px; display: none; }
        #progress-fill { height: 100%; background: var(--s); width: 0%; transition: width 0.1s; }
        .stats { display: flex; justify-content: space-between; font-size: 12px; color: #64748b; margin-top: 10px; }
    </style>
</head>
<body>
<div class="card">
    <div style="text-align: center;">
        <div class="status-tag">
            <div id="status-dot" class="dot"></div>
            <span id="status-text">æ­£åœ¨åˆå§‹åŒ–ç½‘ç»œ...</span>
        </div>
    </div>

    <h3>ğŸš€ æé€Ÿä»£ä¸‹ç«™</h3>
    
    <div id="login-box">
        <input type="text" id="u" placeholder="æ‚¨çš„ä¸“å±è´¦å·">
        <input type="password" id="p" placeholder="æˆæƒå¯†ç ">
        <button id="login-btn" onclick="doLogin()">è¿æ¥æ§åˆ¶ä¸­æ¢</button>
    </div>

    <div id="main-box" style="display:none;">
        <textarea id="share-raw" placeholder="ç›´æ¥ç²˜è´´ç½‘ç›˜åˆ†äº«ä¿¡æ¯..."></textarea>
        <button onclick="sendTask()">æäº¤åŠ é€Ÿä»»åŠ¡</button>
        
        <div id="confirm-box" style="display:none; background:#fffbeb; border:1px solid #fde68a; padding:15px; border-radius:12px; margin-top:15px;">
            <p style="font-size:12px; color:#854d0e; margin:0 0 10px 0;">ğŸ æ–‡ä»¶å·²å‡†å¤‡å¥½ï¼Œè¯·é€‰æ‹©ä¿å­˜ä½ç½®ï¼š</p>
            <button id="save-btn" style="background:#f59e0b;">ğŸ“ é€‰è·¯å¾„å¼€å§‹ä¸‹è½½</button>
        </div>

        <div id="transfer-zone">
            <div id="progress-bar"><div id="progress-fill"></div></div>
            <div class="stats" id="stats-ui" style="display:none;">
                <span id="stat-p">è¿›åº¦: 0%</span>
                <span id="stat-s" style="color:var(--s); font-weight:bold;">0 MB/s</span>
            </div>
            <p id="msg" style="text-align:center; font-size:12px; color:#94a3b8; margin-top:15px;">ç­‰å¾…ä»»åŠ¡æŒ‡ä»¤...</p>
        </div>
    </div>
</div>

<script>
    const ADMIN_ID = 'MY_PRIVATE_STATION_2024'; 
    let peer = new Peer(), conn, recvCtx = null, startTime = 0;

    // ç½‘ç»œçŠ¶æ€æ˜¾ç¤ºé€»è¾‘
    const statusDot = document.getElementById('status-dot');
    const statusText = document.getElementById('status-text');

    function updateStatus(state, msg) {
        statusText.innerText = msg;
        statusDot.className = 'dot ' + state;
    }

    peer.on('open', id => {
        updateStatus('', 'å·²è¿›å…¥ P2P ç½‘ç»œï¼Œè¯·ç™»å½•');
    });

    peer.on('error', err => {
        updateStatus('error', 'ç½‘ç»œè¿æ¥æ•…éšœ');
        console.error(err);
    });

    function doLogin() {
        const u = document.getElementById('u').value, p = document.getElementById('p').value;
        if(!u || !p) return;
        
        updateStatus('', 'æ­£åœ¨å¯»æ‰¾ä¸­æ¢...');
        conn = peer.connect(ADMIN_ID);

        conn.on('open', () => {
            updateStatus('online', 'å·²è¿ä¸Šä¸­æ¢ï¼ŒéªŒè¯èº«ä»½...');
            conn.send({ type: 'AUTH', user: u, pass: p });
        });

        conn.on('close', () => {
            updateStatus('error', 'ä¸­æ¢å·²æ–­å¼€');
            document.getElementById('main-box').style.display = 'none';
            document.getElementById('login-box').style.display = 'block';
        });

        conn.on('data', onData);
    }

    function sendTask() {
        const raw = document.getElementById('share-raw').value;
        if(!raw) return;
        conn.send({ type: 'TASK', rawText: raw });
        document.getElementById('msg').innerText = "ä»»åŠ¡å·²é€è¾¾ç®¡ç†ç«¯ï¼Œè¯·è€å¿ƒç­‰å¾…æ–‡ä»¶...";
    }

    async function onData(data) {
        if(data.type === 'AUTH_OK') {
            updateStatus('sync', 'åŒç«¯å·²åŒæ­¥ | åœ¨çº¿');
            document.getElementById('login-box').style.display = 'none';
            document.getElementById('main-box').style.display = 'block';
        } else if(data.type === 'meta') {
            document.getElementById('confirm-box').style.display = 'block';
            document.getElementById('save-btn').onclick = async () => {
                document.getElementById('confirm-box').style.display = 'none';
                await initSave(data);
            };
        } else if(data.type === 'chunk') {
            handleChunk(data);
        }
    }

    async function initSave(meta) {
        recvCtx = { ...meta, received: 0, currentChunkSize: meta.chunkSize || 262144 };
        document.getElementById('progress-bar').style.display = 'block';
        document.getElementById('stats-ui').style.display = 'flex';
        startTime = Date.now();
        try {
            const h = await window.showSaveFilePicker({ suggestedName: meta.name });
            recvCtx.writer = await h.createWritable();
            conn.send({ type: 'READY_TO_RECEIVE' });
            document.getElementById('msg').innerText = "æ­£åœ¨æ¥æ”¶æ•°æ®ï¼š " + meta.name;
        } catch (e) { 
            conn.send({ type: 'READY_TO_RECEIVE' }); 
        }
    }

    async function handleChunk(pkg) {
        if (recvCtx.writer) await recvCtx.writer.write({ type: 'write', data: pkg.data, position: pkg.offset });
        recvCtx.received++;
        conn.send({ type: 'ACK', index: pkg.index }); 

        if (recvCtx.received % 5 === 0 || pkg.isLast) {
            const duration = (Date.now() - startTime) / 1000;
            const confirmedBytes = recvCtx.received * recvCtx.currentChunkSize;
            const p = (recvCtx.received / recvCtx.chunks * 100).toFixed(1);
            const s = (confirmedBytes / 1024 / 1024 / duration).toFixed(2);
            document.getElementById('progress-fill').style.width = p + '%';
            document.getElementById('stat-p').innerText = `è¿›åº¦: ${p}%`;
            document.getElementById('stat-s').innerText = `${s} MB/s`;
        }

        if (pkg.isLast) {
            if (recvCtx.writer) await recvCtx.writer.close();
            document.getElementById('msg').innerText = "ğŸ‰ ä¼ è¾“å®Œæˆï¼";
            updateStatus('sync', 'ä¼ è¾“å®Œæˆ | å¾…æœºä¸­');
        }
    }
</script>
</body>
</html>
