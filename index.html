<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æé€Ÿä¸‹è½½ - V6.9</title>
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --p: #6366f1; --s: #10b981; }
        body { font-family: system-ui; background: #f1f5f9; display: flex; justify-content: center; padding-top: 50px; margin: 0; }
        .card { background: white; padding: 30px; border-radius: 24px; width: 380px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        h3 { text-align: center; color: #1e293b; margin: 0 0 20px 0; }
        input, textarea, button { width: 100%; padding: 14px; margin: 10px 0; border-radius: 12px; border: 1px solid #e2e8f0; box-sizing: border-box; font-size: 14px; }
        textarea { height: 110px; resize: none; border: 2px solid #f8fafc; transition: 0.3s; }
        textarea:focus { border-color: var(--p); outline: none; background: #fff; }
        button { background: var(--p); color: white; border: none; font-weight: bold; cursor: pointer; }
        #confirm-box { background: #fffbeb; border: 2px dashed #f59e0b; padding: 15px; border-radius: 15px; display: none; margin-top: 15px; }
        #progress-bar { height: 10px; background: #eee; border-radius: 5px; overflow: hidden; margin-top: 20px; display: none; }
        #progress-fill { height: 100%; background: var(--s); width: 0%; transition: width 0.1s; }
        .stats { display: flex; justify-content: space-between; font-size: 12px; color: #64748b; margin-top: 10px; }
    </style>
</head>
<body>
<div class="card">
    <h3>ğŸš€ æé€Ÿä¸‹è½½ç«™</h3>
    
    <div id="login-box">
        <input type="text" id="u" placeholder="è´¦å·">
        <input type="password" id="p" placeholder="å¯†ç ">
        <button onclick="doLogin()">ç™»å½•ç³»ç»Ÿ</button>
    </div>

    <div id="main-box" style="display:none;">
        <textarea id="share-raw" placeholder="ç›´æ¥ç²˜è´´ç™¾åº¦ç½‘ç›˜çš„å®Œæ•´åˆ†äº«æ¶ˆæ¯..."></textarea>
        <button onclick="sendTask()">æäº¤åŠ é€Ÿä»»åŠ¡</button>
        
        <div id="confirm-box">
            <p style="font-size:12px; color:#854d0e; margin-bottom:10px; font-weight:bold;">ğŸ ç®¡ç†å‘˜å·²å‘è´§ï¼Œè¯·ç¡®è®¤ï¼š</p>
            <button id="save-btn" style="background:#f59e0b;">ğŸ“ é€‰å¥½è·¯å¾„ï¼Œå¼€å§‹ä¸‹è½½</button>
        </div>

        <div id="transfer-zone">
            <div id="progress-bar"><div id="progress-fill"></div></div>
            <div class="stats" id="stats-ui" style="display:none;">
                <span id="stat-p">è¿›åº¦: 0%</span>
                <span id="stat-s" style="color:var(--s); font-weight:bold;">0 MB/s</span>
            </div>
            <p id="msg" style="text-align:center; font-size:12px; color:#94a3b8; margin-top:15px;">ç­‰å¾…ä¸­...</p>
        </div>
    </div>
</div>

<script>
    const ADMIN_ID = 'MY_PRIVATE_STATION_2024'; 
    let peer = new Peer(), conn, recvCtx = null, lastT = 0, lastB = 0;

    function doLogin() {
        const u = document.getElementById('u').value, p = document.getElementById('p').value;
        if(!u || !p) return;
        conn = peer.connect(ADMIN_ID);
        conn.on('open', () => conn.send({ type: 'AUTH', user: u, pass: p }));
        conn.on('data', onData);
    }

    function sendTask() {
        const raw = document.getElementById('share-raw').value;
        if(!raw) return;
        conn.send({ type: 'TASK', rawText: raw });
        document.getElementById('msg').innerText = "ä»»åŠ¡æäº¤æˆåŠŸï¼Œè¯·ä¿æŒé¡µé¢å¼€å¯...";
    }

    async function onData(data) {
        if(data.type === 'AUTH_OK') {
            document.getElementById('login-box').style.display = 'none';
            document.getElementById('main-box').style.display = 'block';
        } else if(data.type === 'meta') {
            document.getElementById('confirm-box').style.display = 'block';
            document.getElementById('save-btn').onclick = async () => {
                document.getElementById('confirm-box').style.display = 'none';
                await initSave(data);
            };
        } else if(data.type === 'chunk') {
            handleChunk(data);
        }
    }

    async function initSave(meta) {
        recvCtx = { ...meta, received: 0, bytes: 0 };
        document.getElementById('progress-bar').style.display = 'block';
        document.getElementById('stats-ui').style.display = 'flex';
        lastT = Date.now();
        try {
            const h = await window.showSaveFilePicker({ suggestedName: meta.name });
            recvCtx.writer = await h.createWritable();
            conn.send({ type: 'READY_TO_RECEIVE' });
        } catch (e) { conn.send({ type: 'READY_TO_RECEIVE' }); }
    }

    async function handleChunk(pkg) {
        if (recvCtx.writer) await recvCtx.writer.write({ type: 'write', data: pkg.data, position: pkg.offset });
        recvCtx.received++;
        recvCtx.bytes += pkg.data.byteLength;
        conn.send({ type: 'ACK', index: pkg.index }); // ACKåŒæ­¥

        if (recvCtx.received % 10 === 0 || pkg.isLast) {
            const now = Date.now(), dt = (now - lastT) / 1000;
            const p = (recvCtx.received / recvCtx.chunks * 100).toFixed(1);
            const s = ((recvCtx.bytes - lastB) / 1024 / 1024 / dt).toFixed(2);
            document.getElementById('progress-fill').style.width = p + '%';
            document.getElementById('stat-p').innerText = `è¿›åº¦: ${p}%`;
            document.getElementById('stat-s').innerText = `${s} MB/s`;
            lastT = now; lastB = recvCtx.bytes;
        }

        if (pkg.isLast) {
            if (recvCtx.writer) await recvCtx.writer.close();
            document.getElementById('msg').innerText = "ğŸ‰ ä¼ è¾“å®Œæˆï¼";
        }
    }
</script>
</body>
</html>
