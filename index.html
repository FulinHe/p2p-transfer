<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç½‘ç›˜æé€Ÿä»£ä¸‹ V6.0</title>
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --p: #6366f1; --s: #10b981; }
        body { font-family: system-ui; background: #f1f5f9; display: flex; justify-content: center; padding-top: 50px; }
        .container { background: white; padding: 30px; border-radius: 20px; width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        input, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid #e2e8f0; box-sizing: border-box; }
        button { background: var(--p); color: white; font-weight: bold; cursor: pointer; border: none; }
        #progress-bar { height: 12px; background: #eee; border-radius: 6px; overflow: hidden; margin: 15px 0; display: none; }
        #progress-fill { height: 100%; background: var(--s); width: 0%; transition: width 0.1s; }
        #stats { font-size: 13px; color: #64748b; text-align: center; }
        #confirm-box { background: #fffbeb; border: 2px dashed #f59e0b; padding: 15px; border-radius: 12px; display: none; margin-bottom: 15px; }
    </style>
</head>
<body>
<div class="container">
    <h3>ç½‘ç›˜æé€Ÿä»£ä¸‹</h3>
    <div id="status-bar" style="font-size:12px; margin-bottom:10px; color:#94a3b8;">çŠ¶æ€: æ­£åœ¨åˆå§‹åŒ–...</div>
    
    <div id="input-area">
        <input type="text" id="u" placeholder="è´¦å·">
        <input type="password" id="p" placeholder="å¯†ç ">
        <input type="text" id="share-url" placeholder="ç™¾åº¦ç½‘ç›˜é“¾æ¥">
        <button onclick="doLoginAndSubmit()">æäº¤ä»»åŠ¡</button>
    </div>

    <div id="confirm-box">
        <p style="font-size:13px; color:#854d0e; margin:0 0 10px 0;">ğŸ ç®¡ç†å‘˜å·²å‘è´§ï¼Œè¯·ç¡®è®¤ä¿å­˜ä½ç½®ï¼š</p>
        <button id="save-btn" style="background:#f59e0b;">é€‰å¥½è·¯å¾„ï¼Œå¼€å§‹ä¸‹è½½</button>
    </div>

    <div id="transfer-zone">
        <div id="progress-bar"><div id="progress-fill"></div></div>
        <div id="stats">ç­‰å¾…è¿æ¥...</div>
    </div>
</div>

<script>
    const ADMIN_ID = 'MY_PRIVATE_STATION_2024';
    let peer, conn, recvCtx = null;

    function doLoginAndSubmit() {
        const u = document.getElementById('u').value;
        const p = document.getElementById('p').value;
        const task = document.getElementById('share-url').value;
        if(!u || !p || !task) return alert("è¯·å¡«å…¨ä¿¡æ¯");

        peer = new Peer();
        peer.on('open', id => {
            document.getElementById('status-bar').innerText = 'æˆ‘çš„ ID: ' + id + ' (åœ¨çº¿)';
            conn = peer.connect(ADMIN_ID);
            conn.on('open', () => {
                conn.send({ type: 'AUTH', user: u, pass: p });
                conn.send({ type: 'TASK', rawText: task });
                document.getElementById('input-area').style.display = 'none';
                document.getElementById('stats').innerText = "ä»»åŠ¡å·²æäº¤ï¼Œç­‰å¾…å‘è´§...";
            });
            conn.on('data', onData);
        });
    }

    async function onData(data) {
        if(data.type === 'AUTH_OK') {
            document.getElementById('status-bar').innerText += ' | è®¤è¯æˆåŠŸ';
        } else if(data.type === 'meta') {
            // æ”¶åˆ°å…ƒæ•°æ®ï¼Œè§¦å‘æ‰‹åŠ¿ç¡®è®¤
            document.getElementById('confirm-box').style.display = 'block';
            document.getElementById('save-btn').onclick = async () => {
                document.getElementById('confirm-box').style.display = 'none';
                await initWriter(data);
            };
        } else if(data.type === 'chunk') {
            handleChunk(data);
        }
    }

    async function initWriter(meta) {
        recvCtx = { ...meta, received: 0 };
        document.getElementById('progress-bar').style.display = 'block';
        try {
            const handle = await window.showSaveFilePicker({ suggestedName: meta.name });
            recvCtx.writer = await handle.createWritable();
            conn.send({ type: 'READY_TO_RECEIVE' });
        } catch (e) {
            recvCtx.chunksArray = [];
            document.getElementById('stats').innerText = "âš ï¸ é™çº§ä¸ºå†…å­˜æ¨¡å¼";
            conn.send({ type: 'READY_TO_RECEIVE' });
        }
    }

    async function handleChunk(pkg) {
        if (recvCtx.writer) {
            await recvCtx.writer.write({ type: 'write', data: pkg.data, position: pkg.offset });
        } else {
            recvCtx.chunksArray[pkg.index] = pkg.data;
        }
        recvCtx.received++;
        
        // å‚è€ƒä½ ä»£ç çš„è¿›åº¦æ›´æ–°é¢‘ç‡
        if (recvCtx.received % 10 === 0 || pkg.isLast) {
            const percent = (recvCtx.received / recvCtx.chunks * 100).toFixed(1);
            document.getElementById('progress-fill').style.width = percent + '%';
            document.getElementById('stats').innerText = `æ­£åœ¨æ¥æ”¶: ${percent}%`;
        }

        if (pkg.isLast) {
            if (recvCtx.writer) await recvCtx.writer.close();
            document.getElementById('stats').innerText = "ğŸ‰ æ¥æ”¶å®Œæˆï¼";
        }
    }
</script>
</body>
</html>
